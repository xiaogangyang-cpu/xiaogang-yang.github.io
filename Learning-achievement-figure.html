<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>材料工程基础能力画像 - 增强版生成系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 所有CSS样式保持不变，只修改/添加必要的样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(0, 150, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 2.8rem;
            background: linear-gradient(90deg, #4cc9f0, #4361ee);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #a0a0c0;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 1000px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .image-processing-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 150, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            height: fit-content;
        }
        
        .warrior-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 150, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #4cc9f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.5rem;
        }
        
        .upload-area {
            border: 3px dashed #4361ee;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #4cc9f0;
            background: rgba(76, 201, 240, 0.05);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #4361ee;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #a0a0c0;
        }
        
        .upload-note {
            font-size: 0.9rem;
            color: #8888aa;
        }
        
        #imagePreview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            border: 2px solid #4361ee;
            margin: 20px 0;
            display: none;
        }
        
        .processing-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #4361ee, #3a0ca3);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, #3a0ca3, #4361ee);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid #4361ee;
        }
        
        .btn-secondary:hover {
            background: rgba(67, 97, 238, 0.2);
            transform: translateY(-3px);
        }
        
        .btn-success {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(90deg, #e67e22, #f39c12);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }
        
        .btn-disabled {
            background: #555;
            color: #aaa;
            cursor: not-allowed;
        }
        
        .btn-disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        #warriorCanvas {
            width: 100%;
            max-width: 500px;
            height: 600px;
            background: rgba(10, 15, 35, 0.7);
            border-radius: 10px;
            border: 2px solid #4361ee;
            margin-bottom: 20px;
        }
        
        .warrior-info {
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }
        
        .info-label {
            font-weight: bold;
            color: #a0a0c0;
        }
        
        .info-value {
            color: #4cc9f0;
            font-weight: bold;
        }
        
        .data-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 150, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            grid-column: 1 / -1;
            margin-top: 20px;
        }
        
        .input-group {
            margin-bottom: 25px;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .input-label {
            min-width: 120px;
            font-weight: bold;
            color: #a0a0c0;
        }
        
        .input-field {
            flex: 1;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #4361ee;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #4cc9f0;
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.3);
        }
        
        .slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #4361ee;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .color-legend {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .legend-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #a0a0c0;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-color {
            width: 25px;
            height: 25px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .legend-text {
            color: #e6e6e6;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #a0a0c0;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sample-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .sample-image {
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .sample-image:hover {
            border-color: #4cc9f0;
            transform: translateY(-5px);
        }
        
        .sample-image img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .sample-label {
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            font-size: 0.9rem;
        }
        
        .mastery-display {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .mastery-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .mastery-label {
            font-size: 0.9rem;
            color: #a0a0c0;
            margin-bottom: 5px;
        }
        
        .mastery-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #4361ee;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #a0a0c0;
            font-size: 1rem;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #4cc9f0;
            border-bottom: 3px solid #4cc9f0;
            background: rgba(76, 201, 240, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .part-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .part-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .part-item:hover {
            border-color: #4361ee;
            background: rgba(67, 97, 238, 0.1);
        }
        
        .part-item.selected {
            border-color: #4cc9f0;
            background: rgba(76, 201, 240, 0.2);
        }
        
        .part-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #4361ee;
        }
        
        .selection-instruction {
            padding: 15px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 8px;
            margin: 20px 0;
            color: #a0a0c0;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .polygon-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .polygon-status {
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .point-counter {
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .polygon-points {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            font-size: 0.85rem;
        }
        
        .point-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .point-index {
            color: #a0a0c0;
        }
        
        .point-coords {
            color: #4cc9f0;
        }
        
        .instruction-list {
            margin-top: 15px;
            padding-left: 20px;
        }
        
        .instruction-list li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .student-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 150, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            grid-column: 1 / -1;
            margin-top: 20px;
        }
        
        .excel-template {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .excel-template code {
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #4cc9f0;
        }
        
        .passing-score-info {
            margin-top: 10px;
            padding: 10px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 5px;
            font-size: 0.9rem;
            color: #a0a0c0;
        }
        
        .passing-score-info i {
            color: #4cc9f0;
            margin-right: 5px;
        }
        
        .dynamic-color-legend {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .dynamic-legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        
        .dynamic-color-box {
            width: 30px;
            height: 20px;
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }
        
        .dynamic-color-fill {
            width: 100%;
            height: 100%;
        }
        
        .dynamic-legend-text {
            font-size: 0.9rem;
            color: #e6e6e6;
        }
        
        .color-intensity-bar {
            width: 100%;
            height: 20px;
            border-radius: 10px;
            margin-top: 5px;
            background: linear-gradient(to right, 
                rgba(255, 0, 0, 0.3), 
                rgba(255, 165, 0, 0.5), 
                rgba(255, 255, 0, 0.7), 
                rgba(144, 238, 144, 0.8), 
                rgba(0, 255, 0, 1.0));
            position: relative;
        }
        
        .passing-marker {
            position: absolute;
            top: -5px;
            width: 3px;
            height: 30px;
            background: white;
            transform: translateX(-50%);
        }
        
        .passing-label {
            position: absolute;
            top: -25px;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: white;
            font-weight: bold;
        }
        
        .student-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .student-info-display {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .student-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
        }
        
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s ease;
            cursor: pointer;
        }
        
        .student-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .student-item.active {
            background: rgba(76, 201, 240, 0.2);
            border-left: 3px solid #4cc9f0;
        }
        
        .student-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .student-name {
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .student-id {
            font-size: 0.9rem;
            color: #a0a0c0;
        }
        
        .student-scores {
            display: flex;
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .score-label {
            font-size: 0.8rem;
            color: #a0a0c0;
        }
        
        .score-value {
            color: #4cc9f0;
            font-weight: bold;
        }
        
        .student-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-sm {
            padding: 5px 10px !important;
            font-size: 0.8rem !important;
        }
        
        .generation-progress {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            display: none;
        }
        
        .progress-bar {
            height: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4361ee, #4cc9f0);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #a0a0c0;
        }
        
        /* 修改：待强化项目在一行显示 */
        .weakest-container {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 8px;
            border-left: 4px solid #FF6B6B;
        }
        
        .weakest-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
            padding: 0 10px;
        }
        
        .weakest-label {
            font-size: 0.85rem;
            color: #FF6B6B;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .weakest-value {
            font-size: 1rem;
            font-weight: bold;
            color: #FF6B6B;
        }
        
        .weakest-separator {
            width: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-robot"></i> 材料工程基础能力画像 - 增强版生成系统</h1>
            <p class="subtitle">支持动态达标标准、颜色深浅调整、Excel导入与学生浏览</p>
        </header>
        
        <div class="main-content">
            <div class="image-processing-container">
                <h2 class="section-title"><i class="fas fa-upload"></i> 图像上传与多边形分解</h2>
                
                <div class="tab-container">
                    <div class="tab active" data-tab="upload">上传图片</div>
                    <div class="tab" data-tab="decompose">多边形分解</div>
                    <div class="tab" data-tab="samples">示例图片</div>
                </div>
                
                <div class="tab-content active" id="upload-tab">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">点击或拖拽上传材料工程战士图像</div>
                        <div class="upload-note">支持 JPG, PNG 格式，建议使用透明背景图片</div>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    </div>
                    
                    <img id="imagePreview" alt="上传的图片预览">
                    
                    <div class="processing-controls">
                        <button class="btn btn-primary" id="processBtn" disabled>
                            <i class="fas fa-draw-polygon"></i> 开始多边形分解
                        </button>
                        <button class="btn btn-secondary" id="resetImageBtn">
                            <i class="fas fa-redo"></i> 重新上传
                        </button>
                    </div>
                </div>
                
                <div class="tab-content" id="decompose-tab">
                    <div class="selection-instruction">
                        <h4><i class="fas fa-info-circle"></i> 多边形分解操作指南：</h4>
                        <ol class="instruction-list">
                            <li><strong>选择部件</strong>：在下方选择要分解的部件（头部、躯干、左臂、右臂、双腿）</li>
                            <li><strong>绘制多边形</strong>：在右侧画布上点击边缘点（10-50个点）形成边界</li>
                            <li><strong>闭合多边形</strong>：点击第一个点或点击"闭合多边形"按钮完成当前部件</li>
                            <li><strong>重复操作</strong>：为5个部件分别绘制多边形区域</li>
                            <li><strong>保存设置</strong>：完成后点击"保存分解设置"以便下次使用</li>
                        </ol>
                    </div>
                    
                    <div class="part-selection">
                        <div class="part-item" data-part="head">
                            <div class="part-icon"><i class="fas fa-brain"></i></div>
                            <div>头部<br><small>核心概念</small></div>
                        </div>
                        <div class="part-item" data-part="torso">
                            <div class="part-icon"><i class="fas fa-user"></i></div>
                            <div>躯干<br><small>专业基础</small></div>
                        </div>
                        <!-- 修改：交换left-arm和right-arm的标签 -->
                        <div class="part-item" data-part="left-arm">
                            <div class="part-icon"><i class="fas fa-hand-paper"></i></div>
                            <div>左臂<br><small>分析能力</small></div>
                        </div>
                        <div class="part-item" data-part="right-arm">
                            <div class="part-icon"><i class="fas fa-fist-raised"></i></div>
                            <div>右臂<br><small>实践能力</small></div>
                        </div>
                        <div class="part-item" data-part="legs">
                            <div class="part-icon"><i class="fas fa-walking"></i></div>
                            <div>双腿<br><small>综合素养</small></div>
                        </div>
                    </div>
                    
                    <div class="polygon-status">
                        <div>
                            <span>当前部件：</span>
                            <span id="currentPart" class="point-counter">未选择</span>
                        </div>
                        <div>
                            <span>已绘制点数：</span>
                            <span id="pointCount" class="point-counter">0</span>
                            <span> (建议10-50个点)</span>
                        </div>
                        <div id="pointList" class="polygon-points" style="display:none;">
                            <div class="point-item">
                                <span class="point-index">#</span>
                                <span class="point-coords">坐标(X,Y)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="polygon-controls">
                        <button class="btn btn-primary" id="closePolygonBtn">
                            <i class="fas fa-check-circle"></i> 闭合多边形
                        </button>
                        <button class="btn btn-secondary" id="undoPointBtn">
                            <i class="fas fa-undo"></i> 撤销上一个点
                        </button>
                        <button class="btn btn-secondary" id="clearCurrentPolygonBtn">
                            <i class="fas fa-eraser"></i> 清除当前部件
                        </button>
                        <button class="btn btn-primary" id="confirmDecomposeBtn">
                            <i class="fas fa-check"></i> 确认分解
                        </button>
                    </div>
                    
                    <div class="save-load-controls" style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                        <button class="btn btn-success" id="saveDecompositionBtn">
                            <i class="fas fa-save"></i> 保存分解设置
                        </button>
                        <button class="btn btn-warning" id="loadDecompositionBtn">
                            <i class="fas fa-folder-open"></i> 加载分解设置
                        </button>
                        <button class="btn btn-secondary" id="clearDecompositionBtn">
                            <i class="fas fa-trash"></i> 清除分解设置
                        </button>
                    </div>
                </div>
                
                <div class="tab-content" id="samples-tab">
                    <div class="selection-instruction">
                        <i class="fas fa-lightbulb"></i> 点击下方示例图片快速体验系统功能
                    </div>
                    
                    <div class="sample-images">
                        <div class="sample-image" data-sample="material-warrior1">
                            <div style="width:100%;height:120px;background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);display:flex;justify-content:center;align-items:center;">
                                <i class="fas fa-robot" style="font-size:3rem;color:#4361ee;"></i>
                            </div>
                            <div class="sample-label">材料工程战士1</div>
                        </div>
                        <div class="sample-image" data-sample="material-warrior2">
                            <div style="width:100%;height:120px;background:linear-gradient(135deg, #2c3e50 0%, #34495e 100%);display:flex;justify-content:center;align-items:center;">
                                <i class="fas fa-industry" style="font-size:3rem;color:#3498db;"></i>
                            </div>
                            <div class="sample-label">材料工程战士2</div>
                        </div>
                        <div class="sample-image" data-sample="material-warrior3">
                            <div style="width:100%;height:120px;background:linear-gradient(135deg, #16a085 0%, #1abc9c 100%);display:flex;justify-content:center;align-items:center;">
                                <i class="fas fa-cogs" style="font-size:3rem;color:#2ecc71;"></i>
                            </div>
                            <div class="sample-label">材料工程战士3</div>
                        </div>
                    </div>
                    
                    <div class="excel-template">
                        <h4><i class="fas fa-file-excel"></i> Excel数据模板格式：</h4>
                        <p>Excel文件应包含以下列（顺序任意）：</p>
                        <ul>
                            <li><code>姓名</code> - 学生姓名</li>
                            <li><code>学号</code> - 学生学号</li>
                            <li><code>核心概念</code> - 0-100的分数</li>
                            <li><code>专业基础</code> - 0-100的分数</li>
                            <li><code>分析能力</code> - 0-100的分数</li>
                            <li><code>实践能力</code> - 0-100的分数</li>
                            <li><code>综合素养</code> - 0-100的分数</li>
                        </ul>
                        <p>系统将自动识别列名，不区分大小写。</p>
                    </div>
                </div>
            </div>
            
            <div class="warrior-container">
                <h2 class="section-title"><i class="fas fa-robot"></i> 知识战士展示</h2>
                <div style="position: relative; width: 100%; display: flex; justify-content: center;">
                    <canvas id="warriorCanvas" width="500" height="600"></canvas>
                    <canvas id="selectionCanvas" width="500" height="600" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%);"></canvas>
                </div>
                
                <div class="mastery-display">
                    <div class="mastery-item">
                        <div class="mastery-label">核心概念</div>
                        <div class="mastery-value" id="target1Value">92%</div>
                    </div>
                    <div class="mastery-item">
                        <div class="mastery-label">专业基础</div>
                        <div class="mastery-value" id="target2Value">78%</div>
                    </div>
                    <div class="mastery-item">
                        <div class="mastery-label">分析能力</div>
                        <div class="mastery-value" id="target3Value">65%</div>
                    </div>
                    <div class="mastery-item">
                        <div class="mastery-label">实践能力</div>
                        <div class="mastery-value" id="target4Value">89%</div>
                    </div>
                    <div class="mastery-item">
                        <div class="mastery-label">综合素养</div>
                        <div class="mastery-value" id="target5Value">75%</div>
                    </div>
                </div>
                
                <div class="warrior-info">
                    <div class="info-item">
                        <span class="info-label">学生：</span>
                        <span class="info-value" id="currentStudentName">张三</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">学号：</span>
                        <span class="info-value" id="currentStudentId">S001</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">总掌握度：</span>
                        <span class="info-value" id="totalMastery">78.8%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">最强技能：</span>
                        <span class="info-value" id="strongestSkill">核心概念</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">达标标准：</span>
                        <span class="info-value" id="currentPassingScore">80%</span>
                    </div>
                    
                    <!-- 修改：待强化的最弱两个项目在一行显示 -->
                    <div class="weakest-container">
                        <div class="weakest-item">
                            <div class="weakest-label">需强化项目1</div>
                            <div class="weakest-value" id="weakestSkill1">分析能力 (65%)</div>
                        </div>
                        <div class="weakest-separator"></div>
                        <div class="weakest-item">
                            <div class="weakest-label">需强化项目2</div>
                            <div class="weakest-value" id="weakestSkill2">综合素养 (75%)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="data-panel">
            <h2 class="section-title"><i class="fas fa-edit"></i> 单学生数据控制</h2>
            
            <div class="input-group">
                <div class="input-row">
                    <span class="input-label">学生姓名：</span>
                    <input type="text" class="input-field" id="nameInput" value="张三" placeholder="请输入学生姓名">
                </div>
                
                <div class="input-row">
                    <span class="input-label">学号/ID：</span>
                    <input type="text" class="input-field" id="idInput" value="S001" placeholder="请输入学号">
                </div>
            </div>
            
            <div class="input-group">
                <h3 style="color: #a0a0c0; margin-bottom: 15px;">课程目标达成度 (0-100%)</h3>
                
                <div class="input-row">
                    <span class="input-label">目标1：核心概念</span>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="92" class="slider" id="target1Slider">
                        <span class="slider-value" id="target1Display">92%</span>
                    </div>
                </div>
                
                <div class="input-row">
                    <span class="input-label">目标2：专业基础</span>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="78" class="slider" id="target2Slider">
                        <span class="slider-value" id="target2Display">78%</span>
                    </div>
                </div>
                
                <div class="input-row">
                    <span class="input-label">目标3：分析能力</span>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="65" class="slider" id="target3Slider">
                        <span class="slider-value" id="target3Display">65%</span>
                    </div>
                </div>
                
                <div class="input-row">
                    <span class="input-label">目标4：实践能力</span>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="89" class="slider" id="target4Slider">
                        <span class="slider-value" id="target4Display">89%</span>
                    </div>
                </div>
                
                <div class="input-row">
                    <span class="input-label">目标5：综合素养</span>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="75" class="slider" id="target5Slider">
                        <span class="slider-value" id="target5Display">75%</span>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <h3 style="color: #a0a0c0; margin-bottom: 15px;">达标标准设置</h3>
                
                <div class="input-row">
                    <span class="input-label">达标标准：</span>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="80" class="slider" id="passingScoreSlider">
                        <span class="slider-value" id="passingScoreDisplay">80%</span>
                    </div>
                </div>
                
                <div class="passing-score-info">
                    <i class="fas fa-info-circle"></i>
                    <span id="passingScoreInfo">
                        超过80%的部分颜色会加深，低于80%的部分颜色会变浅。颜色深浅反映与达标标准的差距。
                    </span>
                </div>
                
                <div class="dynamic-color-legend">
                    <div class="dynamic-legend-item">
                        <div class="dynamic-color-box">
                            <div class="dynamic-color-fill" style="background-color: #FF0000; opacity: 0.3;"></div>
                        </div>
                        <span class="dynamic-legend-text">低于标准：颜色浅 (0-30%)</span>
                    </div>
                    <div class="dynamic-legend-item">
                        <div class="dynamic-color-box">
                            <div class="dynamic-color-fill" style="background-color: #FFA500; opacity: 0.5;"></div>
                        </div>
                        <span class="dynamic-legend-text">接近标准：颜色中等 (30-80%)</span>
                    </div>
                    <div class="dynamic-legend-item">
                        <div class="dynamic-color-box">
                            <div class="dynamic-color-fill" style="background-color: #00FF00; opacity: 1.0;"></div>
                        </div>
                        <span class="dynamic-legend-text">超过标准：颜色深 (80-100%)</span>
                    </div>
                    
                    <div class="color-intensity-bar">
                        <div class="passing-marker" id="passingMarker" style="left: 80%;"></div>
                        <div class="passing-label" id="passingLabel" style="left: 80%;">达标标准</div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
                <button class="btn btn-primary" id="updateBtn">
                    <i class="fas fa-sync-alt"></i> 更新着色
                </button>
                <button class="btn btn-secondary" id="randomBtn">
                    <i class="fas fa-dice"></i> 随机生成数据
                </button>
                <button class="btn btn-secondary" id="downloadSingleBtn">
                    <i class="fas fa-download"></i> 下载当前图像
                </button>
                <button class="btn btn-secondary" id="resetDataBtn">
                    <i class="fas fa-redo"></i> 重置数据
                </button>
                <button class="btn btn-success" id="autoUpdateToggle">
                    <i class="fas fa-bolt"></i> 启用实时更新
                </button>
            </div>
            
            <div class="student-info-display" id="currentStudentDisplay" style="display: none;">
                <p>当前查看：<span id="currentStudentIndex">1</span>/<span id="totalStudents">0</span></p>
                <p>学生：<span id="currentProcessingStudent">-</span> (学号: <span id="currentProcessingStudentId">-</span>)</p>
            </div>
        </div>
        
        <div class="student-panel">
            <h2 class="section-title"><i class="fas fa-users"></i> 学生数据导入与浏览</h2>
            
            <div class="selection-instruction">
                <h4><i class="fas fa-info-circle"></i> 使用说明：</h4>
                <ol class="instruction-list">
                    <li><strong>导入Excel</strong>：上传包含所有学生数据的Excel文件</li>
                    <li><strong>浏览学生</strong>：在下方学生列表中点击任意学生，或使用导航按钮</li>
                    <li><strong>查看图像</strong>：选择的学生数据会自动加载到上方控制面板并更新图像</li>
                    <li><strong>下载图像</strong>：点击"下载当前图像"按钮保存当前学生图像</li>
                </ol>
            </div>
            
            <div class="input-group">
                <div class="input-row">
                    <span class="input-label">Excel文件：</span>
                    <input type="file" class="input-field" id="excelFileInput" accept=".xlsx,.xls,.csv">
                    <button class="btn btn-success" id="importExcelBtn" style="white-space: nowrap;">
                        <i class="fas fa-file-import"></i> 导入Excel
                    </button>
                </div>
            </div>
            
            <div class="student-navigation" id="studentNavigation" style="display: none;">
                <button class="btn btn-secondary" id="prevStudentBtn">
                    <i class="fas fa-chevron-left"></i> 上一个学生
                </button>
                
                <div style="text-align: center; min-width: 150px;">
                    <div style="font-size: 1.1rem; color: #4cc9f0;">
                        <span id="navCurrentIndex">1</span>/<span id="navTotalStudents">0</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #a0a0c0;">
                        <span id="navCurrentStudentName">-</span>
                    </div>
                </div>
                
                <button class="btn btn-secondary" id="nextStudentBtn">
                    下一个学生 <i class="fas fa-chevron-right"></i>
                </button>
                
                <button class="btn btn-primary" id="downloadCurrentBtn">
                    <i class="fas fa-download"></i> 下载当前
                </button>
            </div>
            
            <div class="student-list" id="studentListContainer">
                <div style="text-align:center;padding:20px;color:#a0a0c0;">
                    <i class="fas fa-users" style="font-size:2rem;margin-bottom:10px;display:block;"></i>
                    暂无学生数据，请先导入Excel文件
                </div>
            </div>
        </div>
        
        <div class="color-legend">
            <h3 class="legend-title"><i class="fas fa-palette"></i> 颜色等级与动态深浅图例</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #00FF00;"></div>
                    <span class="legend-text">精通 (90-100%) - 颜色最深，表示远超达标标准</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #90EE90;"></div>
                    <span class="legend-text">熟练 (70-89%) - 颜色较深，表示超过达标标准</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFFF00;"></div>
                    <span class="legend-text">掌握 (50-69%) - 颜色中等，接近达标标准</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFA500;"></div>
                    <span class="legend-text">入门 (30-49%) - 颜色较浅，低于达标标准</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF0000;"></div>
                    <span class="legend-text">薄弱 (0-29%) - 颜色最浅，表示与达标标准差距较大</span>
                </div>
            </div>
            
            <div class="dynamic-color-legend" style="margin-top: 20px;">
                <h4 style="color: #a0a0c0; margin-bottom: 10px;"><i class="fas fa-sliders-h"></i> 动态颜色深浅说明</h4>
                <p style="color: #e6e6e6; font-size: 0.9rem; line-height: 1.5;">
                    系统会根据达标标准自动调整颜色深浅：
                    <br>• <strong>超过达标标准</strong>：分数越高，颜色越深（透明度0.8-1.0）
                    <br>• <strong>低于达标标准</strong>：分数越低，颜色越浅（透明度0.3-0.7）
                    <br>• <strong>达标标准可调节</strong>：使用上方的"达标标准"滑块调整基准线
                </p>
            </div>
        </div>
        

    <!-- 引入xlsx.js用于解析Excel文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // 获取Canvas元素和上下文
        const warriorCanvas = document.getElementById('warriorCanvas');
        const warriorCtx = warriorCanvas.getContext('2d');
        const selectionCanvas = document.getElementById('selectionCanvas');
        const selectionCtx = selectionCanvas.getContext('2d');
        
        // 系统状态
        let systemState = {
            originalImage: null,
            imageLoaded: false,
            decomposed: false,
            currentTab: 'upload',
            selectingPart: null,
            isDrawingPolygon: false,
            currentPolygonPoints: [],
            currentMousePos: null,
            partPolygons: {
                'head': [],
                'torso': [],
                'left-arm': [],  // 左臂 -> 分析能力
                'right-arm': [], // 右臂 -> 实践能力
                'legs': []
            },
            partCompleted: {
                'head': false,
                'torso': false,
                'left-arm': false,
                'right-arm': false,
                'legs': false
            },
            currentStudent: {
                name: "张三",
                id: "S001",
                targets: {
                    target1: 92,  // 核心概念
                    target2: 78,  // 专业基础
                    target3: 65,  // 分析能力 (左臂)
                    target4: 89,  // 实践能力 (右臂)
                    target5: 75   // 综合素养
                }
            },
            passingScore: 80,  // 达标标准，默认80%
            allStudents: [],   // 存储所有导入的学生数据
            currentStudentIndex: 0, // 当前查看的学生索引
            autoUpdateEnabled: false // 是否启用实时更新
        };
        
        // ==================== 核心功能函数 ====================
        
        // 动态颜色计算函数
        function calculateDynamicColor(score, passingScore) {
            const baseColors = {
                excellent: '#00FF00',
                good: '#90EE90',
                medium: '#FFFF00',
                basic: '#FFA500',
                weak: '#FF0000'
            };
            
            let baseColor;
            let level;
            
            if (score >= 90) {
                baseColor = baseColors.excellent;
                level = 'excellent';
            } else if (score >= 70) {
                baseColor = baseColors.good;
                level = 'good';
            } else if (score >= 50) {
                baseColor = baseColors.medium;
                level = 'medium';
            } else if (score >= 30) {
                baseColor = baseColors.basic;
                level = 'basic';
            } else {
                baseColor = baseColors.weak;
                level = 'weak';
            }
            
            const gap = score - passingScore;
            let alpha;
            let isPassing = false;
            
            if (gap >= 0) {
                isPassing = true;
                const maxGap = 100 - passingScore;
                const deepness = maxGap > 0 ? Math.min(1, gap / maxGap) : 1;
                alpha = 0.8 + (0.2 * deepness);
            } else {
                isPassing = false;
                const maxGap = passingScore;
                const lightness = maxGap > 0 ? Math.min(1, Math.abs(gap) / maxGap) : 1;
                alpha = 0.3 + (0.5 * (1 - lightness));
            }
            
            alpha = Math.min(1, Math.max(0.3, alpha));
            
            return {
                color: baseColor,
                alpha: alpha,
                isPassing: isPassing,
                score: score,
                gap: gap,
                level: level
            };
        }
        
        // 创建默认多边形区域
        function createDefaultPolygon(part) {
            const canvasWidth = warriorCanvas.width;
            const canvasHeight = warriorCanvas.height;
            
            switch(part) {
                case 'head':
                    return [
                        {x: canvasWidth * 0.4, y: canvasHeight * 0.1},
                        {x: canvasWidth * 0.6, y: canvasHeight * 0.1},
                        {x: canvasWidth * 0.65, y: canvasHeight * 0.25},
                        {x: canvasWidth * 0.35, y: canvasHeight * 0.25}
                    ];
                case 'torso':
                    return [
                        {x: canvasWidth * 0.35, y: canvasHeight * 0.25},
                        {x: canvasWidth * 0.65, y: canvasHeight * 0.25},
                        {x: canvasWidth * 0.65, y: canvasHeight * 0.55},
                        {x: canvasWidth * 0.35, y: canvasHeight * 0.55}
                    ];
                case 'left-arm':
                    return [
                        {x: canvasWidth * 0.2, y: canvasHeight * 0.3},
                        {x: canvasWidth * 0.35, y: canvasHeight * 0.3},
                        {x: canvasWidth * 0.35, y: canvasHeight * 0.5},
                        {x: canvasWidth * 0.2, y: canvasHeight * 0.5}
                    ];
                case 'right-arm':
                    return [
                        {x: canvasWidth * 0.65, y: canvasHeight * 0.3},
                        {x: canvasWidth * 0.8, y: canvasHeight * 0.3},
                        {x: canvasWidth * 0.8, y: canvasHeight * 0.5},
                        {x: canvasWidth * 0.65, y: canvasHeight * 0.5}
                    ];
                case 'legs':
                    return [
                        {x: canvasWidth * 0.4, y: canvasHeight * 0.55},
                        {x: canvasWidth * 0.6, y: canvasHeight * 0.55},
                        {x: canvasWidth * 0.55, y: canvasHeight * 0.85},
                        {x: canvasWidth * 0.45, y: canvasHeight * 0.85}
                    ];
                default:
                    return [];
            }
        }
        
        // 绘制知识战士
        function drawWarrior(student = null) {
            warriorCtx.clearRect(0, 0, warriorCanvas.width, warriorCanvas.height);
            
            if (!systemState.imageLoaded) {
                drawDefaultBackground();
                return;
            }
            
            warriorCtx.drawImage(systemState.originalImage, 0, 0, warriorCanvas.width, warriorCanvas.height);
            
            if (systemState.decomposed) {
                applyColorToPolygons(student || systemState.currentStudent);
            }
            
            if (systemState.decomposed) {
                drawKnowledgeConnections();
            }
            
            const studentToDraw = student || systemState.currentStudent;
            drawStudentInfo(studentToDraw);
            
            if (!student) {
                updateDisplayInfo(studentToDraw);
            }
        }
        
        // 绘制默认背景
        function drawDefaultBackground() {
            const gradient = warriorCtx.createLinearGradient(0, 0, 0, warriorCanvas.height);
            gradient.addColorStop(0, 'rgba(10, 15, 35, 0.9)');
            gradient.addColorStop(1, 'rgba(5, 10, 25, 0.9)');
            warriorCtx.fillStyle = gradient;
            warriorCtx.fillRect(0, 0, warriorCanvas.width, warriorCanvas.height);
            
            warriorCtx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            warriorCtx.font = 'bold 24px Arial';
            warriorCtx.textAlign = 'center';
            warriorCtx.fillText('请上传材料工程战士图像并分解', warriorCanvas.width / 2, warriorCanvas.height / 2 - 30);
            
            warriorCtx.font = '18px Arial';
            warriorCtx.fillText('上传图片后点击"开始多边形分解"按钮', warriorCanvas.width / 2, warriorCanvas.height / 2 + 10);
        }
        
        // 应用颜色到多边形区域
        function applyColorToPolygons(student) {
            warriorCtx.save();
            const passingScore = systemState.passingScore;
            const parts = ['head', 'torso', 'left-arm', 'right-arm', 'legs'];
            const targetKeys = ['target1', 'target2', 'target3', 'target4', 'target5'];
            
            const offscreenCanvas = document.createElement('canvas');
            offscreenCanvas.width = warriorCanvas.width;
            offscreenCanvas.height = warriorCanvas.height;
            const offscreenCtx = offscreenCanvas.getContext('2d');
            
            const colorRegions = [];
            
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                let polygon = systemState.partPolygons[part];
                
                if (!polygon || polygon.length < 3) {
                    polygon = createDefaultPolygon(part);
                    systemState.partPolygons[part] = polygon;
                    systemState.partCompleted[part] = true;
                }
                
                if (polygon && polygon.length >= 3) {
                    const score = student.targets[targetKeys[i]];
                    const colorInfo = calculateDynamicColor(score, passingScore);
                    
                    colorRegions.push({
                        polygon: polygon,
                        colorInfo: colorInfo,
                        part: part
                    });
                }
            }
            
            colorRegions.forEach(region => {
                offscreenCtx.save();
                offscreenCtx.beginPath();
                offscreenCtx.moveTo(region.polygon[0].x, region.polygon[0].y);
                for (let j = 1; j < region.polygon.length; j++) {
                    offscreenCtx.lineTo(region.polygon[j].x, region.polygon[j].y);
                }
                offscreenCtx.closePath();
                offscreenCtx.clip();
                
                offscreenCtx.globalCompositeOperation = 'source-atop';
                offscreenCtx.globalAlpha = region.colorInfo.alpha;
                offscreenCtx.fillStyle = region.colorInfo.color;
                offscreenCtx.fillRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
                
                offscreenCtx.restore();
            });
            
            warriorCtx.drawImage(offscreenCanvas, 0, 0);
            
            colorRegions.forEach(region => {
                drawPolygonBoundary(region.polygon, region.colorInfo);
                drawScoreLabel(region.polygon, region.colorInfo.score, region.colorInfo.isPassing);
            });
            
            warriorCtx.restore();
        }
        
        // 绘制多边形边界
        function drawPolygonBoundary(polygon, colorInfo) {
            warriorCtx.save();
            warriorCtx.beginPath();
            warriorCtx.moveTo(polygon[0].x, polygon[0].y);
            for (let i = 1; i < polygon.length; i++) {
                warriorCtx.lineTo(polygon[i].x, polygon[i].y);
            }
            warriorCtx.closePath();
            
            if (colorInfo.isPassing) {
                warriorCtx.strokeStyle = colorInfo.color;
                warriorCtx.lineWidth = 3;
                warriorCtx.shadowColor = colorInfo.color;
                warriorCtx.shadowBlur = 10;
            } else {
                warriorCtx.strokeStyle = '#FFFFFF';
                warriorCtx.lineWidth = 2;
                warriorCtx.setLineDash([5, 5]);
            }
            
            warriorCtx.stroke();
            warriorCtx.restore();
        }
        
        // 绘制分数标签
        function drawScoreLabel(polygon, score, isPassing) {
            if (polygon.length === 0) return;
            
            let sumX = 0, sumY = 0;
            for (const point of polygon) {
                sumX += point.x;
                sumY += point.y;
            }
            const centerX = sumX / polygon.length;
            const centerY = sumY / polygon.length;
            
            warriorCtx.save();
            warriorCtx.fillStyle = isPassing ? 'rgba(0, 0, 0, 0.8)' : 'rgba(0, 0, 0, 0.6)';
            warriorCtx.fillRect(centerX - 30, centerY - 15, 60, 30);
            
            warriorCtx.fillStyle = '#FFFFFF';
            warriorCtx.font = 'bold 16px Arial';
            warriorCtx.textAlign = 'center';
            warriorCtx.textBaseline = 'middle';
            warriorCtx.fillText(`${score}%`, centerX, centerY);
            warriorCtx.restore();
        }
        
        // 计算多边形中心点
        function calculatePolygonCenter(polygon) {
            if (polygon.length === 0) return {x: 0, y: 0};
            
            let sumX = 0;
            let sumY = 0;
            
            for (let i = 0; i < polygon.length; i++) {
                sumX += polygon[i].x;
                sumY += polygon[i].y;
            }
            
            return {
                x: sumX / polygon.length,
                y: sumY / polygon.length
            };
        }
        
        // 绘制知识脉络连线
        function drawKnowledgeConnections() {
            warriorCtx.strokeStyle = 'rgba(76, 201, 240, 0.7)';
            warriorCtx.lineWidth = 3;
            warriorCtx.setLineDash([5, 5]);
            
            const centers = {};
            const parts = ['head', 'torso', 'left-arm', 'right-arm', 'legs'];
            
            for (const part of parts) {
                const polygon = systemState.partPolygons[part];
                if (polygon && polygon.length > 0) {
                    centers[part] = calculatePolygonCenter(polygon);
                }
            }
            
            if (centers['torso']) {
                const torsoCenter = centers['torso'];
                
                if (centers['head']) {
                    warriorCtx.beginPath();
                    warriorCtx.moveTo(torsoCenter.x, torsoCenter.y);
                    warriorCtx.lineTo(centers['head'].x, centers['head'].y);
                    warriorCtx.stroke();
                }
                
                if (centers['left-arm']) {
                    warriorCtx.beginPath();
                    warriorCtx.moveTo(torsoCenter.x, torsoCenter.y);
                    warriorCtx.lineTo(centers['left-arm'].x, centers['left-arm'].y);
                    warriorCtx.stroke();
                }
                
                if (centers['right-arm']) {
                    warriorCtx.beginPath();
                    warriorCtx.moveTo(torsoCenter.x, torsoCenter.y);
                    warriorCtx.lineTo(centers['right-arm'].x, centers['right-arm'].y);
                    warriorCtx.stroke();
                }
                
                if (centers['legs']) {
                    warriorCtx.beginPath();
                    warriorCtx.moveTo(torsoCenter.x, torsoCenter.y);
                    warriorCtx.lineTo(centers['legs'].x, centers['legs'].y);
                    warriorCtx.stroke();
                }
            }
            
            warriorCtx.setLineDash([]);
        }
        
        // 获取最弱项目（辅助函数）
        function getWeakestSkills(student, count = 2) {
            const targets = [
                {name: "核心概念", value: student.targets.target1, key: "target1"},
                {name: "专业基础", value: student.targets.target2, key: "target2"},
                {name: "分析能力", value: student.targets.target3, key: "target3"},
                {name: "实践能力", value: student.targets.target4, key: "target4"},
                {name: "综合素养", value: student.targets.target5, key: "target5"}
            ];
            
            // 按分数升序排序（分数最低的排前面）
            const sortedTargets = [...targets].sort((a, b) => a.value - b.value);
            
            // 只返回低于达标标准的项目
            const belowPassing = sortedTargets.filter(item => item.value < systemState.passingScore);
            
            // 如果低于标准的项目不足count个，返回所有低于标准的，或者返回最差的count个
            if (belowPassing.length >= count) {
                return belowPassing.slice(0, count);
            } else if (belowPassing.length > 0) {
                return belowPassing;
            } else {
                // 如果所有项目都达标，返回最需要提高的（分数最低的）
                return sortedTargets.slice(0, count);
            }
        }
        
        // 绘制学生信息（修改：在学号下方、生成时间上方添加需强化项目）
        function drawStudentInfo(student) {
            // 计算需要强化的项目
            const weakestSkills = getWeakestSkills(student);
            const weakestStr = weakestSkills.length > 0 ? 
                `需强化：${weakestSkills.map(item => item.name).join('、')}` : 
                "所有项目均已达标";
            
            // 计算绘制位置
            const infoStartY = warriorCanvas.height - 100; // 从底部开始向上100px
            const lineHeight = 20; // 每行高度
            
            // 绘制半透明背景框（可选，增强可读性）
            warriorCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            warriorCtx.fillRect(20, infoStartY - 5, 460, 95);
            
            // 绘制学生信息
            warriorCtx.fillStyle = '#000000';
            warriorCtx.font = 'bold 16px Arial';
            warriorCtx.textAlign = 'left';
            
            // 第1行：学生姓名
            warriorCtx.fillText(`学生：${student.name}`, 50, infoStartY+ lineHeight);
            
            // 第2行：学号
            warriorCtx.fillText(`学号：${student.id}`, 50, infoStartY + lineHeight * 2);
            
            // 第3行：需强化项目（新增）
            warriorCtx.fillStyle = '#FF6B6B'; // 使用醒目的红色
            warriorCtx.font = 'bold 16px Arial';
            warriorCtx.fillText(weakestStr, 50, infoStartY + lineHeight * 3);
            
            // 第4行：生成时间
            warriorCtx.fillStyle = '#000000'; // 黑色，次要信息
            warriorCtx.font = '14px Arial';
            warriorCtx.fillText('生成时间：' + new Date().toLocaleString(), 270, infoStartY + lineHeight * 4);
        }
        
        // 更新显示信息（修改：计算并显示最弱两个项目）
        function updateDisplayInfo(student) {
            document.getElementById('currentStudentName').textContent = student.name;
            document.getElementById('currentStudentId').textContent = student.id;
            document.getElementById('currentPassingScore').textContent = `${systemState.passingScore}%`;
            
            document.getElementById('target1Value').textContent = `${student.targets.target1}%`;
            document.getElementById('target2Value').textContent = `${student.targets.target2}%`;
            document.getElementById('target3Value').textContent = `${student.targets.target3}%`;
            document.getElementById('target4Value').textContent = `${student.targets.target4}%`;
            document.getElementById('target5Value').textContent = `${student.targets.target5}%`;
            
            const totalMastery = (
                student.targets.target1 + 
                student.targets.target2 + 
                student.targets.target3 + 
                student.targets.target4 + 
                student.targets.target5
            ) / 5;
            
            document.getElementById('totalMastery').textContent = `${totalMastery.toFixed(1)}%`;
            
            const targets = [
                {name: "核心概念", value: student.targets.target1, key: "target1"},
                {name: "专业基础", value: student.targets.target2, key: "target2"},
                {name: "分析能力", value: student.targets.target3, key: "target3"},
                {name: "实践能力", value: student.targets.target4, key: "target4"},
                {name: "综合素养", value: student.targets.target5, key: "target5"}
            ];
            
            // 找出最强技能
            const strongest = targets.reduce((prev, current) => 
                (prev.value > current.value) ? prev : current
            );
            document.getElementById('strongestSkill').textContent = strongest.name;
            
            // 找出最弱的两个项目
            const sortedTargets = [...targets].sort((a, b) => a.value - b.value);
            const weakestTwo = sortedTargets.slice(0, 2);
            
            // 更新最弱两个项目的显示
            if (weakestTwo.length > 0) {
                document.getElementById('weakestSkill1').textContent = 
                    `${weakestTwo[0].name} (${weakestTwo[0].value}%)`;
            }
            
            if (weakestTwo.length > 1) {
                document.getElementById('weakestSkill2').textContent = 
                    `${weakestTwo[1].name} (${weakestTwo[1].value}%)`;
            }
            
            updatePassingScoreDisplay();
        }
        
        // 更新达标标准显示
        function updatePassingScoreDisplay() {
            const passingScore = systemState.passingScore;
            document.getElementById('passingScoreDisplay').textContent = `${passingScore}%`;
            document.getElementById('passingScoreInfo').textContent = 
                `超过${passingScore}%的部分颜色会加深，低于${passingScore}%的部分颜色会变浅。颜色深浅反映与达标标准的差距。`;
            
            const passingMarker = document.getElementById('passingMarker');
            const passingLabel = document.getElementById('passingLabel');
            const leftPosition = `${passingScore}%`;
            
            passingMarker.style.left = leftPosition;
            passingLabel.style.left = leftPosition;
            passingLabel.textContent = `达标标准: ${passingScore}%`;
        }
        
        // 绘制选择界面
        function drawSelectionInterface() {
            selectionCtx.clearRect(0, 0, selectionCanvas.width, selectionCanvas.height);
            
            if (systemState.originalImage) {
                selectionCtx.globalAlpha = 0.5;
                selectionCtx.drawImage(systemState.originalImage, 0, 0, selectionCanvas.width, selectionCanvas.height);
                selectionCtx.globalAlpha = 1;
            }
            
            const parts = ['head', 'torso', 'left-arm', 'right-arm', 'legs'];
            const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF'];
            
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                const polygon = systemState.partPolygons[part];
                
                if (polygon && polygon.length > 0) {
                    selectionCtx.strokeStyle = colors[i];
                    selectionCtx.lineWidth = 3;
                    selectionCtx.beginPath();
                    selectionCtx.moveTo(polygon[0].x, polygon[0].y);
                    for (let j = 1; j < polygon.length; j++) {
                        selectionCtx.lineTo(polygon[j].x, polygon[j].y);
                    }
                    selectionCtx.closePath();
                    selectionCtx.stroke();
                    
                    selectionCtx.fillStyle = colors[i] + '40';
                    selectionCtx.fill();
                    
                    const center = calculatePolygonCenter(polygon);
                    selectionCtx.fillStyle = colors[i];
                    selectionCtx.font = 'bold 16px Arial';
                    selectionCtx.textAlign = 'center';
                    selectionCtx.fillText(part.toUpperCase(), center.x, center.y);
                }
            }
            
            if (systemState.isDrawingPolygon && systemState.currentPolygonPoints.length > 0) {
                for (let i = 0; i < systemState.currentPolygonPoints.length; i++) {
                    const point = systemState.currentPolygonPoints[i];
                    selectionCtx.fillStyle = '#4cc9f0';
                    selectionCtx.beginPath();
                    selectionCtx.arc(point.x, point.y, 5, 0, Math.PI * 2);
                    selectionCtx.fill();
                    
                    selectionCtx.fillStyle = '#FFFFFF';
                    selectionCtx.font = 'bold 12px Arial';
                    selectionCtx.textAlign = 'center';
                    selectionCtx.textBaseline = 'middle';
                    selectionCtx.fillText((i+1).toString(), point.x, point.y);
                }
                
                if (systemState.currentPolygonPoints.length > 1) {
                    selectionCtx.strokeStyle = '#4cc9f0';
                    selectionCtx.lineWidth = 2;
                    selectionCtx.beginPath();
                    selectionCtx.moveTo(systemState.currentPolygonPoints[0].x, systemState.currentPolygonPoints[0].y);
                    for (let i = 1; i < systemState.currentPolygonPoints.length; i++) {
                        selectionCtx.lineTo(systemState.currentPolygonPoints[i].x, systemState.currentPolygonPoints[i].y);
                    }
                    selectionCtx.stroke();
                    
                    if (systemState.currentPolygonPoints.length > 2 && systemState.currentMousePos) {
                        selectionCtx.strokeStyle = '#4cc9f0';
                        selectionCtx.lineWidth = 1;
                        selectionCtx.setLineDash([5, 5]);
                        selectionCtx.beginPath();
                        const lastPoint = systemState.currentPolygonPoints[systemState.currentPolygonPoints.length - 1];
                        selectionCtx.moveTo(lastPoint.x, lastPoint.y);
                        selectionCtx.lineTo(systemState.currentMousePos.x, systemState.currentMousePos.y);
                        selectionCtx.stroke();
                        
                        selectionCtx.beginPath();
                        selectionCtx.moveTo(systemState.currentPolygonPoints[0].x, systemState.currentPolygonPoints[0].y);
                        selectionCtx.lineTo(systemState.currentMousePos.x, systemState.currentMousePos.y);
                        selectionCtx.stroke();
                        selectionCtx.setLineDash([]);
                    }
                }
            }
        }
        
        // 更新点列表显示
        function updatePointList() {
            const pointList = document.getElementById('pointList');
            const pointCount = document.getElementById('pointCount');
            
            pointCount.textContent = systemState.currentPolygonPoints.length;
            
            while (pointList.children.length > 1) {
                pointList.removeChild(pointList.lastChild);
            }
            
            systemState.currentPolygonPoints.forEach((point, index) => {
                const pointItem = document.createElement('div');
                pointItem.className = 'point-item';
                pointItem.innerHTML = `
                    <span class="point-index">${index + 1}</span>
                    <span class="point-coords">(${Math.round(point.x)}, ${Math.round(point.y)})</span>
                `;
                pointList.appendChild(pointItem);
            });
            
            if (systemState.currentPolygonPoints.length > 0) {
                pointList.style.display = 'block';
            } else {
                pointList.style.display = 'none';
            }
        }
        
        // ==================== 原有功能初始化 ====================
        
        // 初始化上传功能
        function initUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            const imagePreview = document.getElementById('imagePreview');
            const processBtn = document.getElementById('processBtn');
            
            uploadArea.addEventListener('click', () => {
                imageInput.click();
            });
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#4cc9f0';
                uploadArea.style.background = 'rgba(76, 201, 240, 0.1)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#4361ee';
                uploadArea.style.background = 'rgba(0, 0, 0, 0.2)';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#4361ee';
                uploadArea.style.background = 'rgba(0, 0, 0, 0.2)';
                
                if (e.dataTransfer.files.length) {
                    const file = e.dataTransfer.files[0];
                    if (file.type.match('image.*')) {
                        loadImageFile(file);
                    } else {
                        alert('请上传图片文件！');
                    }
                }
            });
            
            imageInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    const file = e.target.files[0];
                    loadImageFile(file);
                }
            });
            
            function loadImageFile(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        systemState.originalImage = img;
                        systemState.imageLoaded = true;
                        
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                        
                        processBtn.disabled = false;
                        processBtn.classList.remove('btn-disabled');
                        
                        drawWarrior();
                        
                        loadDecompositionFromStorage();
                    };
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
            
            processBtn.addEventListener('click', () => {
                if (systemState.imageLoaded) {
                    switchTab('decompose');
                    drawSelectionInterface();
                }
            });
            
            document.getElementById('resetImageBtn').addEventListener('click', () => {
                systemState.originalImage = null;
                systemState.imageLoaded = false;
                systemState.decomposed = false;
                
                imagePreview.style.display = 'none';
                imageInput.value = '';
                processBtn.disabled = true;
                processBtn.classList.add('btn-disabled');
                
                resetPolygons();
                drawWarrior();
            });
        }
        
        // 初始化多边形分解功能
        function initPolygonDecomposition() {
            const partItems = document.querySelectorAll('.part-item');
            partItems.forEach(item => {
                item.addEventListener('click', () => {
                    partItems.forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    
                    systemState.selectingPart = item.dataset.part;
                    document.getElementById('currentPart').textContent = getPartName(systemState.selectingPart);
                    
                    if (systemState.partPolygons[systemState.selectingPart].length > 0) {
                        systemState.currentPolygonPoints = [...systemState.partPolygons[systemState.selectingPart]];
                        systemState.isDrawingPolygon = true;
                        updatePointList();
                    } else {
                        systemState.currentPolygonPoints = [];
                        systemState.isDrawingPolygon = true;
                        updatePointList();
                    }
                    
                    startPolygonDrawing();
                });
            });
            
            selectionCanvas.addEventListener('click', addPolygonPoint);
            selectionCanvas.addEventListener('mousemove', updateMousePosition);
            
            document.getElementById('closePolygonBtn').addEventListener('click', closePolygon);
            document.getElementById('undoPointBtn').addEventListener('click', undoLastPoint);
            document.getElementById('clearCurrentPolygonBtn').addEventListener('click', clearCurrentPolygon);
            document.getElementById('confirmDecomposeBtn').addEventListener('click', confirmDecomposition);
            document.getElementById('saveDecompositionBtn').addEventListener('click', saveDecompositionToStorage);
            document.getElementById('loadDecompositionBtn').addEventListener('click', loadDecompositionFromStorage);
            document.getElementById('clearDecompositionBtn').addEventListener('click', clearDecompositionFromStorage);
        }
        
        // 开始多边形绘制
        function startPolygonDrawing() {
            systemState.isDrawingPolygon = true;
            systemState.currentMousePos = null;
            updatePointList();
            drawSelectionInterface();
        }
        
        // 添加多边形点
        function addPolygonPoint(e) {
            if (!systemState.isDrawingPolygon || !systemState.selectingPart) return;
            
            const rect = selectionCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (systemState.currentPolygonPoints.length >= 3) {
                const firstPoint = systemState.currentPolygonPoints[0];
                const distance = Math.sqrt(Math.pow(x - firstPoint.x, 2) + Math.pow(y - firstPoint.y, 2));
                
                if (distance < 15) {
                    closePolygon();
                    return;
                }
            }
            
            systemState.currentPolygonPoints.push({x, y});
            updatePointList();
            drawSelectionInterface();
            
            if (systemState.currentPolygonPoints.length >= 50) {
                alert('已添加50个点，建议点击第一个点或使用"闭合多边形"按钮完成绘制。');
            }
        }
        
        // 更新鼠标位置
        function updateMousePosition(e) {
            if (!systemState.isDrawingPolygon) return;
            
            const rect = selectionCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            systemState.currentMousePos = {x, y};
            drawSelectionInterface();
        }
        
        // 闭合多边形
        function closePolygon() {
            if (!systemState.selectingPart || systemState.currentPolygonPoints.length < 3) {
                alert('至少需要3个点才能闭合多边形！');
                return;
            }
            
            systemState.partPolygons[systemState.selectingPart] = [...systemState.currentPolygonPoints];
            systemState.partCompleted[systemState.selectingPart] = true;
            
            systemState.currentPolygonPoints = [];
            systemState.isDrawingPolygon = false;
            
            updatePointList();
            drawSelectionInterface();
            
            checkAllPartsCompleted();
        }
        
        // 撤销上一个点
        function undoLastPoint() {
            if (systemState.currentPolygonPoints.length > 0) {
                systemState.currentPolygonPoints.pop();
                updatePointList();
                drawSelectionInterface();
            }
        }
        
        // 清除当前部件
        function clearCurrentPolygon() {
            if (systemState.selectingPart) {
                systemState.partPolygons[systemState.selectingPart] = [];
                systemState.partCompleted[systemState.selectingPart] = false;
                systemState.currentPolygonPoints = [];
                systemState.isDrawingPolygon = false;
                
                updatePointList();
                drawSelectionInterface();
            }
        }
        
        // 确认分解
        function confirmDecomposition() {
            let allCompleted = true;
            for (const part in systemState.partCompleted) {
                if (!systemState.partCompleted[part]) {
                    allCompleted = false;
                    break;
                }
            }
            
            if (!allCompleted) {
                const parts = ['head', 'torso', 'left-arm', 'right-arm', 'legs'];
                parts.forEach(part => {
                    if (!systemState.partCompleted[part]) {
                        systemState.partPolygons[part] = createDefaultPolygon(part);
                        systemState.partCompleted[part] = true;
                        console.log(`为${part}创建了默认多边形`);
                    }
                });
            }
            
            systemState.decomposed = true;
            drawWarrior();
            saveDecompositionToStorage();
            
            alert('多边形分解完成！所有部分都已激活，现在可以调整数据和查看着色效果。');
        }
        
        // 检查所有部件是否完成
        function checkAllPartsCompleted() {
            let allCompleted = true;
            for (const part in systemState.partCompleted) {
                if (!systemState.partCompleted[part]) {
                    allCompleted = false;
                    break;
                }
            }
            
            if (allCompleted) {
                const confirmBtn = document.getElementById('confirmDecomposeBtn');
                confirmBtn.style.background = 'linear-gradient(90deg, #00FF00, #00CC00)';
                confirmBtn.innerHTML = '<i class="fas fa-check"></i> 所有部件已完成！点击确认分解';
            }
        }
        
        // 重置所有多边形
        function resetPolygons() {
            systemState.partPolygons = {
                'head': [],
                'torso': [],
                'left-arm': [],
                'right-arm': [],
                'legs': []
            };
            
            systemState.partCompleted = {
                'head': false,
                'torso': false,
                'left-arm': false,
                'right-arm': false,
                'legs': false
            };
            
            systemState.selectingPart = null;
            systemState.currentPolygonPoints = [];
            systemState.isDrawingPolygon = false;
            systemState.decomposed = false;
            
            document.querySelectorAll('.part-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const confirmBtn = document.getElementById('confirmDecomposeBtn');
            confirmBtn.style.background = '';
            confirmBtn.innerHTML = '<i class="fas fa-check"></i> 确认分解';
            
            document.getElementById('currentPart').textContent = '未选择';
            updatePointList();
        }
        
        // 获取部件名称（修改：交换left-arm和right-arm的标签）
        function getPartName(partKey) {
            const partNames = {
                'head': '头部（核心概念）',
                'torso': '躯干（专业基础）',
                'left-arm': '左臂（分析能力）',  // 修改：left-arm对应左臂
                'right-arm': '右臂（实践能力）', // 修改：right-arm对应右臂
                'legs': '双腿（综合素养）'
            };
            return partNames[partKey] || partKey;
        }
        
        // 保存分解设置到本地存储
        function saveDecompositionToStorage() {
            if (!systemState.imageLoaded) {
                alert('请先上传图像！');
                return;
            }
            
            let allCompleted = true;
            for (const part in systemState.partCompleted) {
                if (!systemState.partCompleted[part]) {
                    allCompleted = false;
                    break;
                }
            }
            
            if (!allCompleted) {
                if (!confirm('尚未完成所有部件的分解，确定要保存当前进度吗？')) {
                    return;
                }
            }
            
            try {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 200;
                tempCanvas.height = 240;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(systemState.originalImage, 0, 0, 200, 240);
                const imageDataUrl = tempCanvas.toDataURL('image/jpeg', 0.8);
                
                const saveData = {
                    imageData: imageDataUrl,
                    partPolygons: systemState.partPolygons,
                    partCompleted: systemState.partCompleted,
                    decomposed: systemState.decomposed,
                    saveTime: new Date().toISOString()
                };
                
                localStorage.setItem('materialWarriorDecomposition', JSON.stringify(saveData));
                
                alert('分解设置已保存到本地存储！');
            } catch (error) {
                console.error('保存分解设置失败:', error);
                alert('保存失败，请重试！');
            }
        }
        
        // 从本地存储加载分解设置
        function loadDecompositionFromStorage() {
            try {
                const savedData = localStorage.getItem('materialWarriorDecomposition');
                if (!savedData) {
                    alert('未找到已保存的分解设置！');
                    return;
                }
                
                const parsedData = JSON.parse(savedData);
                
                if (!parsedData.imageData || !parsedData.partPolygons) {
                    alert('保存的数据格式不正确！');
                    return;
                }
                
                systemState.partPolygons = parsedData.partPolygons;
                systemState.partCompleted = parsedData.partCompleted || {
                    'head': false,
                    'torso': false,
                    'left-arm': false,
                    'right-arm': false,
                    'legs': false
                };
                
                for (const part in systemState.partPolygons) {
                    if (systemState.partPolygons[part].length > 0) {
                        systemState.partCompleted[part] = true;
                    }
                }
                
                systemState.decomposed = parsedData.decomposed || false;
                
                if (systemState.decomposed) {
                    drawWarrior();
                }
                
                drawSelectionInterface();
                checkAllPartsCompleted();
                
                alert(`分解设置已加载（保存时间：${new Date(parsedData.saveTime).toLocaleString()}）`);
            } catch (error) {
                console.error('加载分解设置失败:', error);
                alert('加载失败，保存的数据可能已损坏！');
            }
        }
        
        // 清除本地存储中的分解设置
        function clearDecompositionFromStorage() {
            if (confirm('确定要清除已保存的分解设置吗？此操作不可恢复！')) {
                localStorage.removeItem('materialWarriorDecomposition');
                alert('分解设置已清除！');
            }
        }
        
        // 初始化标签页切换
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    switchTab(tabId);
                });
            });
        }
        
        // 切换标签页
        function switchTab(tabId) {
            systemState.currentTab = tabId;
            
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                if (content.id === `${tabId}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            if (tabId === 'decompose' && systemState.imageLoaded) {
                drawSelectionInterface();
            }
        }
        
        // 初始化示例图片
        function initSamples() {
            const sampleImages = document.querySelectorAll('.sample-image');
            let selectedSample = null;
            
            sampleImages.forEach(img => {
                img.addEventListener('click', () => {
                    sampleImages.forEach(i => i.style.borderColor = '');
                    img.style.borderColor = '#4cc9f0';
                    
                    selectedSample = img.dataset.sample;
                    
                    const imgElement = new Image();
                    imgElement.onload = function() {
                        systemState.originalImage = imgElement;
                        systemState.imageLoaded = true;
                        
                        const imagePreview = document.getElementById('imagePreview');
                        imagePreview.src = imgElement.src;
                        imagePreview.style.display = 'block';
                        
                        const processBtn = document.getElementById('processBtn');
                        processBtn.disabled = false;
                        processBtn.classList.remove('btn-disabled');
                        
                        drawWarrior();
                        loadDecompositionFromStorage();
                        switchTab('upload');
                        
                        alert('示例图片已加载！请点击"开始多边形分解"按钮继续。');
                    };
                    
                    if (selectedSample === 'material-warrior1') {
                        imgElement.src = createMaterialWarrior1();
                    } else if (selectedSample === 'material-warrior2') {
                        imgElement.src = createMaterialWarrior2();
                    } else if (selectedSample === 'material-warrior3') {
                        imgElement.src = createMaterialWarrior3();
                    }
                });
            });
        }
        
        // 创建材料工程战士示例图像1
        function createMaterialWarrior1() {
            const canvas = document.createElement('canvas');
            canvas.width = 500;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = 'rgba(10, 15, 35, 0.9)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#4361ee';
            ctx.beginPath();
            ctx.ellipse(250, 100, 50, 60, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(200, 160, 100, 120);
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 10; i++) {
                ctx.beginPath();
                ctx.moveTo(200 + i * 10, 160);
                ctx.lineTo(200 + i * 10, 280);
                ctx.stroke();
            }
            for (let i = 0; i < 12; i++) {
                ctx.beginPath();
                ctx.moveTo(200, 160 + i * 10);
                ctx.lineTo(300, 160 + i * 10);
                ctx.stroke();
            }
            
            ctx.fillStyle = '#ecf0f1';
            ctx.fillRect(140, 180, 60, 80);
            
            ctx.fillStyle = '#e67e22';
            ctx.fillRect(300, 180, 60, 80);
            
            ctx.fillStyle = '#34495e';
            ctx.fillRect(220, 280, 60, 100);
            ctx.fillRect(220, 380, 60, 100);
            
            return canvas.toDataURL();
        }
        
        // 创建材料工程战士示例图像2
        function createMaterialWarrior2() {
            const canvas = document.createElement('canvas');
            canvas.width = 500;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#16213e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#3498db';
            ctx.beginPath();
            ctx.roundRect(200, 80, 100, 80, [20, 20, 20, 20]);
            ctx.fill();
            
            ctx.fillStyle = '#2c3e50';
            ctx.beginPath();
            ctx.roundRect(180, 160, 140, 140, [10, 10, 10, 10]);
            ctx.fill();
            
            ctx.fillStyle = '#bdc3c7';
            ctx.fillRect(120, 180, 60, 100);
            
            ctx.fillStyle = '#d35400';
            ctx.fillRect(320, 180, 60, 100);
            
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(200, 300, 40, 120);
            ctx.fillRect(260, 300, 40, 120);
            
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 2;
            ctx.strokeRect(200, 80, 100, 80);
            ctx.strokeRect(180, 160, 140, 140);
            ctx.strokeRect(120, 180, 60, 100);
            ctx.strokeRect(320, 180, 60, 100);
            ctx.strokeRect(200, 300, 40, 120);
            ctx.strokeRect(260, 300, 40, 120);
            
            return canvas.toDataURL();
        }
        
        // 创建材料工程战士示例图像3
        function createMaterialWarrior3() {
            const canvas = document.createElement('canvas');
            canvas.width = 500;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = 'rgba(22, 34, 62, 0.9)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#9b59b6';
            ctx.beginPath();
            ctx.arc(250, 100, 50, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#16a085';
            ctx.fillRect(210, 150, 80, 120);
            
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(150, 170, 60, 80);
            
            ctx.fillStyle = '#f39c12';
            ctx.fillRect(290, 170, 60, 80);
            
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(230, 270, 40, 100);
            ctx.fillRect(230, 370, 40, 100);
            
            return canvas.toDataURL();
        }
        
        // 初始化数据控制功能
        function initDataControls() {
            initSliders();
            initButtons();
            initPassingScoreControl();
            initAutoUpdateControl();
        }
        
        // 初始化滑块事件监听
        function initSliders() {
            const target1Slider = document.getElementById('target1Slider');
            const target1Display = document.getElementById('target1Display');
            
            target1Slider.addEventListener('input', function() {
                target1Display.textContent = this.value + '%';
                systemState.currentStudent.targets.target1 = parseInt(this.value);
                
                if (systemState.autoUpdateEnabled && systemState.decomposed) {
                    drawWarrior();
                }
            });
            
            const target2Slider = document.getElementById('target2Slider');
            const target2Display = document.getElementById('target2Display');
            
            target2Slider.addEventListener('input', function() {
                target2Display.textContent = this.value + '%';
                systemState.currentStudent.targets.target2 = parseInt(this.value);
                
                if (systemState.autoUpdateEnabled && systemState.decomposed) {
                    drawWarrior();
                }
            });
            
            const target3Slider = document.getElementById('target3Slider');
            const target3Display = document.getElementById('target3Display');
            
            target3Slider.addEventListener('input', function() {
                target3Display.textContent = this.value + '%';
                systemState.currentStudent.targets.target3 = parseInt(this.value);
                
                if (systemState.autoUpdateEnabled && systemState.decomposed) {
                    drawWarrior();
                }
            });
            
            const target4Slider = document.getElementById('target4Slider');
            const target4Display = document.getElementById('target4Display');
            
            target4Slider.addEventListener('input', function() {
                target4Display.textContent = this.value + '%';
                systemState.currentStudent.targets.target4 = parseInt(this.value);
                
                if (systemState.autoUpdateEnabled && systemState.decomposed) {
                    drawWarrior();
                }
            });
            
            const target5Slider = document.getElementById('target5Slider');
            const target5Display = document.getElementById('target5Display');
            
            target5Slider.addEventListener('input', function() {
                target5Display.textContent = this.value + '%';
                systemState.currentStudent.targets.target5 = parseInt(this.value);
                
                if (systemState.autoUpdateEnabled && systemState.decomposed) {
                    drawWarrior();
                }
            });
            
            document.getElementById('nameInput').addEventListener('input', function() {
                systemState.currentStudent.name = this.value;
            });
            
            document.getElementById('idInput').addEventListener('input', function() {
                systemState.currentStudent.id = this.value;
            });
        }
        
        // 初始化达标标准控制
        function initPassingScoreControl() {
            const passingScoreSlider = document.getElementById('passingScoreSlider');
            const passingScoreDisplay = document.getElementById('passingScoreDisplay');
            
            updatePassingScoreDisplay();
            
            passingScoreSlider.addEventListener('input', function() {
                const value = parseInt(this.value);
                systemState.passingScore = value;
                updatePassingScoreDisplay();
                
                if (systemState.decomposed) {
                    drawWarrior();
                }
            });
        }
        
        // 初始化实时更新控制
        function initAutoUpdateControl() {
            const autoUpdateToggle = document.getElementById('autoUpdateToggle');
            
            updateAutoUpdateButton();
            
            autoUpdateToggle.addEventListener('click', function() {
                systemState.autoUpdateEnabled = !systemState.autoUpdateEnabled;
                updateAutoUpdateButton();
                
                if (systemState.autoUpdateEnabled && systemState.decomposed) {
                    drawWarrior();
                }
            });
        }
        
        // 更新实时更新按钮状态
        function updateAutoUpdateButton() {
            const autoUpdateToggle = document.getElementById('autoUpdateToggle');
            
            if (systemState.autoUpdateEnabled) {
                autoUpdateToggle.innerHTML = '<i class="fas fa-bolt"></i> 实时更新已启用';
                autoUpdateToggle.classList.remove('btn-success');
                autoUpdateToggle.classList.add('btn-warning');
            } else {
                autoUpdateToggle.innerHTML = '<i class="fas fa-bolt"></i> 启用实时更新';
                autoUpdateToggle.classList.remove('btn-warning');
                autoUpdateToggle.classList.add('btn-success');
            }
        }
        
        // 初始化按钮事件
        function initButtons() {
            document.getElementById('updateBtn').addEventListener('click', function() {
                if (systemState.decomposed) {
                    drawWarrior();
                } else {
                    alert('请先上传并分解图像！');
                }
            });
            
            document.getElementById('randomBtn').addEventListener('click', function() {
                systemState.currentStudent.targets.target1 = Math.floor(Math.random() * 41) + 60;
                systemState.currentStudent.targets.target2 = Math.floor(Math.random() * 41) + 60;
                systemState.currentStudent.targets.target3 = Math.floor(Math.random() * 41) + 60;
                systemState.currentStudent.targets.target4 = Math.floor(Math.random() * 41) + 60;
                systemState.currentStudent.targets.target5 = Math.floor(Math.random() * 41) + 60;
                
                document.getElementById('target1Slider').value = systemState.currentStudent.targets.target1;
                document.getElementById('target1Display').textContent = systemState.currentStudent.targets.target1 + '%';
                
                document.getElementById('target2Slider').value = systemState.currentStudent.targets.target2;
                document.getElementById('target2Display').textContent = systemState.currentStudent.targets.target2 + '%';
                
                document.getElementById('target3Slider').value = systemState.currentStudent.targets.target3;
                document.getElementById('target3Display').textContent = systemState.currentStudent.targets.target3 + '%';
                
                document.getElementById('target4Slider').value = systemState.currentStudent.targets.target4;
                document.getElementById('target4Display').textContent = systemState.currentStudent.targets.target4 + '%';
                
                document.getElementById('target5Slider').value = systemState.currentStudent.targets.target5;
                document.getElementById('target5Display').textContent = systemState.currentStudent.targets.target5 + '%';
                
                if (systemState.decomposed) {
                    drawWarrior();
                }
            });
            
            document.getElementById('downloadSingleBtn').addEventListener('click', function() {
                if (!systemState.decomposed) {
                    alert('请先上传并分解图像！');
                    return;
                }
                
                const link = document.createElement('a');
                link.download = `材料工程知识战士_${systemState.currentStudent.name}_${systemState.currentStudent.id}.png`;
                link.href = warriorCanvas.toDataURL('image/png');
                link.click();
            });
            
            document.getElementById('resetDataBtn').addEventListener('click', function() {
                systemState.currentStudent = {
                    name: "张三",
                    id: "S001",
                    targets: {
                        target1: 92,
                        target2: 78,
                        target3: 65,
                        target4: 89,
                        target5: 75
                    }
                };
                
                document.getElementById('nameInput').value = systemState.currentStudent.name;
                document.getElementById('idInput').value = systemState.currentStudent.id;
                
                document.getElementById('target1Slider').value = systemState.currentStudent.targets.target1;
                document.getElementById('target1Display').textContent = systemState.currentStudent.targets.target1 + '%';
                
                document.getElementById('target2Slider').value = systemState.currentStudent.targets.target2;
                document.getElementById('target2Display').textContent = systemState.currentStudent.targets.target2 + '%';
                
                document.getElementById('target3Slider').value = systemState.currentStudent.targets.target3;
                document.getElementById('target3Display').textContent = systemState.currentStudent.targets.target3 + '%';
                
                document.getElementById('target4Slider').value = systemState.currentStudent.targets.target4;
                document.getElementById('target4Display').textContent = systemState.currentStudent.targets.target4 + '%';
                
                document.getElementById('target5Slider').value = systemState.currentStudent.targets.target5;
                document.getElementById('target5Display').textContent = systemState.currentStudent.targets.target5 + '%';
                
                if (systemState.decomposed) {
                    drawWarrior();
                }
            });
        }
        
        // ==================== 新增学生导入与浏览功能 ====================
        
        // 加载学生数据到控制面板
        function loadStudentDataToControls(index) {
            if (systemState.allStudents.length === 0 || index >= systemState.allStudents.length) {
                return;
            }
            
            const student = systemState.allStudents[index];
            systemState.currentStudentIndex = index;
            
            // 更新单学生控制面板
            document.getElementById('nameInput').value = student.name;
            document.getElementById('idInput').value = student.id;
            
            document.getElementById('target1Slider').value = student.targets.target1;
            document.getElementById('target1Display').textContent = student.targets.target1 + '%';
            
            document.getElementById('target2Slider').value = student.targets.target2;
            document.getElementById('target2Display').textContent = student.targets.target2 + '%';
            
            document.getElementById('target3Slider').value = student.targets.target3;
            document.getElementById('target3Display').textContent = student.targets.target3 + '%';
            
            document.getElementById('target4Slider').value = student.targets.target4;
            document.getElementById('target4Display').textContent = student.targets.target4 + '%';
            
            document.getElementById('target5Slider').value = student.targets.target5;
            document.getElementById('target5Display').textContent = student.targets.target5 + '%';
            
            // 更新当前学生显示
            document.getElementById('currentStudentIndex').textContent = index + 1;
            document.getElementById('totalStudents').textContent = systemState.allStudents.length;
            document.getElementById('currentProcessingStudent').textContent = student.name;
            document.getElementById('currentProcessingStudentId').textContent = student.id;
            
            // 更新导航显示
            document.getElementById('navCurrentIndex').textContent = index + 1;
            document.getElementById('navTotalStudents').textContent = systemState.allStudents.length;
            document.getElementById('navCurrentStudentName').textContent = student.name;
            
            // 更新系统状态中的当前学生
            systemState.currentStudent = JSON.parse(JSON.stringify(student));
            
            // 更新学生列表中的高亮
            highlightCurrentStudentInList();
            
            // 如果已经分解，立即重绘canvas
            if (systemState.decomposed) {
                drawWarrior();
            }
            
            // 更新显示信息
            updateDisplayInfo(student);
        }
        
        // 高亮学生列表中的当前学生
        function highlightCurrentStudentInList() {
            const studentItems = document.querySelectorAll('.student-item');
            studentItems.forEach((item, index) => {
                if (index === systemState.currentStudentIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // 更新学生列表显示
        function updateStudentListDisplay() {
            const container = document.getElementById('studentListContainer');
            
            if (systemState.allStudents.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#a0a0c0;">
                        <i class="fas fa-users" style="font-size:2rem;margin-bottom:10px;display:block;"></i>
                        暂无学生数据，请先导入Excel文件
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            systemState.allStudents.forEach((student, index) => {
                const avgScore = (
                    student.targets.target1 + 
                    student.targets.target2 + 
                    student.targets.target3 + 
                    student.targets.target4 + 
                    student.targets.target5
                ) / 5;
                
                const passingCount = Object.values(student.targets).filter(score => score >= systemState.passingScore).length;
                const passingPercentage = Math.round((passingCount / 5) * 100);
                
                const statusClass = index === systemState.currentStudentIndex ? 'active' : '';
                
                html += `
                    <div class="student-item ${statusClass}" data-index="${index}">
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-id">${student.id}</div>
                            <div style="font-size:0.8rem;color:${passingPercentage >= 60 ? '#2ecc71' : '#e74c3c'}">
                                达标率: ${passingPercentage}% (${passingCount}/5)
                            </div>
                        </div>
                        <div class="student-scores">
                            <div class="score-item">
                                <div class="score-label">平均</div>
                                <div class="score-value">${avgScore.toFixed(1)}%</div>
                            </div>
                            <div class="score-item">
                                <div class="score-label">最高</div>
                                <div class="score-value">${Math.max(
                                    student.targets.target1,
                                    student.targets.target2,
                                    student.targets.target3,
                                    student.targets.target4,
                                    student.targets.target5
                                )}%</div>
                            </div>
                        </div>
                        <div class="student-actions">
                            <button class="btn btn-primary btn-sm btn-load" data-index="${index}">
                                <i class="fas fa-eye"></i> 查看
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            container.querySelectorAll('.btn-load').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    loadStudentDataToControls(index);
                });
            });
            
            container.querySelectorAll('.student-item').forEach(item => {
                item.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    loadStudentDataToControls(index);
                });
            });
        }
        
        // 初始化学生导入功能
        function initStudentImport() {
            document.getElementById('importExcelBtn').addEventListener('click', importExcelData);
            document.getElementById('prevStudentBtn').addEventListener('click', navigateToPrevStudent);
            document.getElementById('nextStudentBtn').addEventListener('click', navigateToNextStudent);
            document.getElementById('downloadCurrentBtn').addEventListener('click', downloadCurrentStudent);
        }
        
        // 导入Excel数据
        function importExcelData() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请先选择Excel文件！');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    if (jsonData.length <= 1) {
                        alert('Excel文件中没有数据！');
                        return;
                    }
                    
                    const headers = jsonData[0];
                    const students = [];
                    
                    const nameIndex = headers.findIndex(h => 
                        typeof h === 'string' && (h.includes('姓名') || h.includes('name') || h.includes('Name'))
                    );
                    
                    const idIndex = headers.findIndex(h => 
                        typeof h === 'string' && (h.includes('学号') || h.includes('id') || h.includes('ID') || h.includes('学号'))
                    );
                    
                    const targetIndices = {
                        target1: headers.findIndex(h => 
                            typeof h === 'string' && (h.includes('核心概念') || h.includes('目标1') || h.includes('概念'))
                        ),
                        target2: headers.findIndex(h => 
                            typeof h === 'string' && (h.includes('专业基础') || h.includes('目标2') || h.includes('基础'))
                        ),
                        target3: headers.findIndex(h => 
                            typeof h === 'string' && (h.includes('分析能力') || h.includes('目标3') || h.includes('分析'))
                        ),
                        target4: headers.findIndex(h => 
                            typeof h === 'string' && (h.includes('实践能力') || h.includes('目标4') || h.includes('实践'))
                        ),
                        target5: headers.findIndex(h => 
                            typeof h === 'string' && (h.includes('综合素养') || h.includes('目标5') || h.includes('综合'))
                        )
                    };
                    
                    if (nameIndex === -1) {
                        alert('Excel文件中没有找到"姓名"列！');
                        return;
                    }
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;
                        
                        const student = {
                            name: String(row[nameIndex] || `学生${i}`),
                            id: idIndex !== -1 ? String(row[idIndex] || `ID${i}`) : `ID${i}`,
                            targets: {
                                target1: parseFloat(row[targetIndices.target1]) || 0,
                                target2: parseFloat(row[targetIndices.target2]) || 0,
                                target3: parseFloat(row[targetIndices.target3]) || 0,
                                target4: parseFloat(row[targetIndices.target4]) || 0,
                                target5: parseFloat(row[targetIndices.target5]) || 0
                            }
                        };
                        
                        for (const key in student.targets) {
                            if (student.targets[key] < 0) student.targets[key] = 0;
                            if (student.targets[key] > 100) student.targets[key] = 100;
                        }
                        
                        students.push(student);
                    }
                    
                    if (students.length === 0) {
                        alert('没有成功导入任何学生数据！');
                        return;
                    }
                    
                    systemState.allStudents = students;
                    systemState.currentStudentIndex = 0;
                    
                    updateStudentListDisplay();
                    
                    document.getElementById('studentNavigation').style.display = 'flex';
                    document.getElementById('currentStudentDisplay').style.display = 'block';
                    
                    loadStudentDataToControls(0);
                    
                    alert(`成功导入 ${students.length} 名学生数据！`);
                    
                } catch (error) {
                    console.error('解析Excel文件失败:', error);
                    alert('解析Excel文件失败，请检查文件格式！');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 导航到上一个学生
        function navigateToPrevStudent() {
            if (systemState.allStudents.length === 0) {
                alert('没有学生数据！');
                return;
            }
            
            let newIndex = systemState.currentStudentIndex - 1;
            if (newIndex < 0) {
                newIndex = systemState.allStudents.length - 1;
            }
            
            loadStudentDataToControls(newIndex);
        }
        
        // 导航到下一个学生
        function navigateToNextStudent() {
            if (systemState.allStudents.length === 0) {
                alert('没有学生数据！');
                return;
            }
            
            let newIndex = systemState.currentStudentIndex + 1;
            if (newIndex >= systemState.allStudents.length) {
                newIndex = 0;
            }
            
            loadStudentDataToControls(newIndex);
        }
        
        // 下载当前学生图像
        function downloadCurrentStudent() {
            if (!systemState.decomposed) {
                alert('请先完成图像分解！');
                return;
            }
            
            const student = systemState.currentStudent;
            
            const link = document.createElement('a');
            link.download = `材料工程知识战士_${student.name}_${student.id}.png`;
            link.href = warriorCanvas.toDataURL('image/png');
            link.click();
            
            alert(`已下载 ${student.name} 的图像！`);
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            initTabs();
            initUpload();
            initPolygonDecomposition();
            initSamples();
            initDataControls();
            initStudentImport();
            
            drawWarrior();
            
            // 添加背景纹理
            const texture = document.createElement('div');
            texture.className = 'puzzle-texture';
            texture.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: 
                    radial-gradient(circle at 25% 25%, rgba(76, 201, 240, 0.05) 2px, transparent 2px),
                    radial-gradient(circle at 75% 75%, rgba(67, 97, 238, 0.05) 2px, transparent 2px);
                background-size: 60px 60px;
                z-index: -1;
                pointer-events: none;
            `;
            document.body.appendChild(texture);
            
            // 检查是否有保存的分解设置
            setTimeout(() => {
                if (localStorage.getItem('materialWarriorDecomposition')) {
                    if (confirm('检测到已保存的分解设置，是否加载？')) {
                        loadDecompositionFromStorage();
                    }
                }
            }, 1000);
        });
    </script>

<!-- 底部信息栏 -->
<div style="
    text-align: center;
    padding: 20px 30px;
    margin-top: 40px;
    color: #e6f7ff;
    font-size: 0.9rem;
    border-top: 2px solid rgba(0, 180, 255, 0.5);
    background: linear-gradient(135deg, rgba(10, 15, 43, 0.95), rgba(18, 26, 58, 0.9));
    border-radius: 15px 15px 0 0;
    box-shadow: 0 -10px 30px rgba(0, 180, 255, 0.1);
    position: relative;
    overflow: hidden;
    box-sizing: border-box;
    width: 100%;
    max-width: none;
">
    <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #00b4ff, #6c8cff, #00b4ff);"></div>
    
    <p style="font-size: 1.3rem; font-weight: bold; margin-bottom: 15px; color: #00b4ff;">
        材料工程知识战士增强版生成系统 © 2025 | 材料工程基础虚拟仿真系统 | 版本 1.0 |
      <style="margin-bottom: 12px; color: #cbd5e1;">
        <strong>邮箱:</strong> xgyanger@qq.com
    </p>
    
    <div style="margin-top: 15px;">
        <span style="color: #ffcc00; font-weight: bold; font-size: 1.1rem;">
            版权©2025 AIknow. 保留所有权利 | Copyright ©2025 AIknow. All rights reserved.
        </span>
    </div>
</div>




</body>
</html>